# AUTOGENERATED! DO NOT EDIT! File to edit: nbs/74_callback.azureml.ipynb (unless otherwise specified).

__all__ = ['AzureMLCallback']

# Cell
import tempfile
from ..basics import *
from ..learner import Callback

# Cell
from azureml.core.run import Run

# Cell
class AzureMLCallback(Callback):
    "Log losses, metrics, model architecture summary to AzureML"
    order = Recorder.order+1

    def before_fit(self):
        self.run = Run.get_context()

        self.run.log("n_epoch", self.learn.n_epoch)
        self.run.log("model_class", str(type(self.learn.model)))

        try:
            summary_file = Path("outputs") / 'model_summary.txt'
            with summary_file.open("w") as f:
                f.write(repr(self.learn.model))
        except:
            print('Did not log model summary. Check if your model is PyTorch model.')

    def after_batch(self):
        # log loss and opt.hypers
        if self.learn.training:
            # self.run.log('batch__smooth_loss', self.learn.smooth_loss)
            self.run.log('batch__loss', self.learn.loss)
            self.run.log('batch__train_iter', self.learn.train_iter)
            for i, h in enumerate(self.learn.opt.hypers):
                for k, v in h.items():
                    self.run.log(f'batch__opt.hypers.{k}', v)

    def after_epoch(self):
        # log metrics
        for n, v in zip(self.learn.recorder.metric_names, self.learn.recorder.log):
            if n not in ['epoch', 'time']:
                self.run.log(f'epoch__{n}', v)
            if n == 'time':
                self.run.log(f'epoch__{n}', str(v))