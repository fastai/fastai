---

title: Collaborative filtering


keywords: fastai
sidebar: home_sidebar

summary: "Tools to quickly get the data and train models suitable for collaborative filtering"
description: "Tools to quickly get the data and train models suitable for collaborative filtering"
nb_path: "nbs/45_collab.ipynb"
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/45_collab.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
        
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">

<div class="output_subarea output_stream output_stderr output_text">
<pre>/opt/conda/lib/python3.9/site-packages/torch/cuda/__init__.py:145: UserWarning: 
NVIDIA GeForce RTX 3070 Laptop GPU with CUDA capability sm_86 is not compatible with the current PyTorch installation.
The current PyTorch install supports CUDA capabilities sm_37 sm_50 sm_60 sm_70.
If you want to use the NVIDIA GeForce RTX 3070 Laptop GPU GPU with PyTorch, please check the instructions at https://pytorch.org/get-started/locally/

  warnings.warn(incompatible_device_warn.format(device_name, capability, &#34; &#34;.join(arch_list), device_name))
</pre>
</div>
</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This module contains all the high-level functions you need in a collaborative filtering application to assemble your data, get a model and train it with a <a href="/learner.html#Learner"><code>Learner</code></a>. We will go other those in order but you can also check the <a href="http://docs.fast.ai/tutorial.collab">collaborative filtering tutorial</a>.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Gather-the-data">Gather the data<a class="anchor-link" href="#Gather-the-data"> </a></h2>
</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="TabularCollab" class="doc_header"><code>class</code> <code>TabularCollab</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L9" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>TabularCollab</code>(<strong><code>df</code></strong>, <strong><code>procs</code></strong>=<em><code>None</code></em>, <strong><code>cat_names</code></strong>=<em><code>None</code></em>, <strong><code>cont_names</code></strong>=<em><code>None</code></em>, <strong><code>y_names</code></strong>=<em><code>None</code></em>, <strong><code>y_block</code></strong>=<em><code>None</code></em>, <strong><code>splits</code></strong>=<em><code>None</code></em>, <strong><code>do_setup</code></strong>=<em><code>True</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>, <strong><code>inplace</code></strong>=<em><code>False</code></em>, <strong><code>reduce_memory</code></strong>=<em><code>True</code></em>) :: <a href="/tabular.core.html#TabularPandas"><code>TabularPandas</code></a></p>
</blockquote>
<p>Instance of <a href="/tabular.core.html#TabularPandas"><code>TabularPandas</code></a> suitable for collaborative filtering (with no continuous variable)</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This is just to use the internal of the tabular application, don't worry about it.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="CollabDataLoaders" class="doc_header"><code>class</code> <code>CollabDataLoaders</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L14" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>CollabDataLoaders</code>(<strong>*<code>loaders</code></strong>, <strong><code>path</code></strong>:<code>(str, Path)</code>=<em><code>'.'</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>) :: <a href="/data.core.html#DataLoaders"><code>DataLoaders</code></a></p>
</blockquote>
<p>Base <a href="/data.core.html#DataLoaders"><code>DataLoaders</code></a> for collaborative filtering.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This class should not be used directly, one of the factory methods should be preferred instead. All those factory methods accept as arguments:</p>
<ul>
<li><code>valid_pct</code>: the random percentage of the dataset to set aside for validation (with an optional <code>seed</code>)</li>
<li><code>user_name</code>: the name of the column containing the user (defaults to the first column)</li>
<li><code>item_name</code>: the name of the column containing the item (defaults to the second column)</li>
<li><code>rating_name</code>: the name of the column containing the rating (defaults to the third column)</li>
<li><code>path</code>: the folder where to work</li>
<li><code>bs</code>: the batch size</li>
<li><code>val_bs</code>: the batch size for the validation <a href="/data.load.html#DataLoader"><code>DataLoader</code></a> (defaults to <code>bs</code>)</li>
<li><code>shuffle_train</code>: if we shuffle the training <a href="/data.load.html#DataLoader"><code>DataLoader</code></a> or not</li>
<li><code>device</code>: the PyTorch device to use (defaults to <code>default_device()</code>)</li>
</ul>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CollabDataLoaders.from_df" class="doc_header"><code>CollabDataLoaders.from_df</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L16" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CollabDataLoaders.from_df</code>(<strong><code>ratings</code></strong>, <strong><code>valid_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>user_name</code></strong>=<em><code>None</code></em>, <strong><code>item_name</code></strong>=<em><code>None</code></em>, <strong><code>rating_name</code></strong>=<em><code>None</code></em>, <strong><code>seed</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>bs</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>val_bs</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong><code>shuffle</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Create a <a href="/data.core.html#DataLoaders"><code>DataLoaders</code></a> suitable for collaborative filtering from <code>ratings</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see how this works on an example:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">path</span> <span class="o">=</span> <span class="n">untar_data</span><span class="p">(</span><span class="n">URLs</span><span class="o">.</span><span class="n">ML_SAMPLE</span><span class="p">)</span>
<span class="n">ratings</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">read_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;ratings.csv&#39;</span><span class="p">)</span>
<span class="n">ratings</span><span class="o">.</span><span class="n">head</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea output_execute_result"><div>
<style scoped>
    .dataframe tbody tr th:only-of-type {
        vertical-align: middle;
    }

    .dataframe tbody tr th {
        vertical-align: top;
    }

    .dataframe thead th {
        text-align: right;
    }
</style>
<table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
      <th>timestamp</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>73</td>
      <td>1097</td>
      <td>4.0</td>
      <td>1255504951</td>
    </tr>
    <tr>
      <th>1</th>
      <td>561</td>
      <td>924</td>
      <td>3.5</td>
      <td>1172695223</td>
    </tr>
    <tr>
      <th>2</th>
      <td>157</td>
      <td>260</td>
      <td>3.5</td>
      <td>1291598691</td>
    </tr>
    <tr>
      <th>3</th>
      <td>358</td>
      <td>1210</td>
      <td>5.0</td>
      <td>957481884</td>
    </tr>
    <tr>
      <th>4</th>
      <td>130</td>
      <td>316</td>
      <td>2.0</td>
      <td>1138999234</td>
    </tr>
  </tbody>
</table>
</div></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">CollabDataLoaders</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="n">ratings</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
<span class="n">dls</span><span class="o">.</span><span class="n">show_batch</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: right;">
      <th></th>
      <th>userId</th>
      <th>movieId</th>
      <th>rating</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <th>0</th>
      <td>157</td>
      <td>1265</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>1</th>
      <td>130</td>
      <td>2858</td>
      <td>2.0</td>
    </tr>
    <tr>
      <th>2</th>
      <td>481</td>
      <td>1196</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>3</th>
      <td>105</td>
      <td>597</td>
      <td>3.5</td>
    </tr>
    <tr>
      <th>4</th>
      <td>128</td>
      <td>597</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>5</th>
      <td>587</td>
      <td>5952</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>6</th>
      <td>111</td>
      <td>2571</td>
      <td>5.0</td>
    </tr>
    <tr>
      <th>7</th>
      <td>105</td>
      <td>356</td>
      <td>3.0</td>
    </tr>
    <tr>
      <th>8</th>
      <td>77</td>
      <td>5349</td>
      <td>4.0</td>
    </tr>
    <tr>
      <th>9</th>
      <td>119</td>
      <td>1240</td>
      <td>4.0</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="CollabDataLoaders.from_csv" class="doc_header"><code>CollabDataLoaders.from_csv</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L28" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>CollabDataLoaders.from_csv</code>(<strong><code>csv</code></strong>, <strong><code>valid_pct</code></strong>=<em><code>0.2</code></em>, <strong><code>user_name</code></strong>=<em><code>None</code></em>, <strong><code>item_name</code></strong>=<em><code>None</code></em>, <strong><code>rating_name</code></strong>=<em><code>None</code></em>, <strong><code>seed</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>'.'</code></em>, <strong><code>bs</code></strong>:<code>int</code>=<em><code>64</code></em>, <strong><code>val_bs</code></strong>:<code>int</code>=<em><code>None</code></em>, <strong><code>shuffle</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>device</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Create a <a href="/data.core.html#DataLoaders"><code>DataLoaders</code></a> suitable for collaborative filtering from <code>csv</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span> <span class="o">=</span> <span class="n">CollabDataLoaders</span><span class="o">.</span><span class="n">from_csv</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;ratings.csv&#39;</span><span class="p">,</span> <span class="n">bs</span><span class="o">=</span><span class="mi">64</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Models">Models<a class="anchor-link" href="#Models"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>fastai provides two kinds of models for collaborative filtering: a dot-product model and a neural net.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EmbeddingDotBias" class="doc_header"><code>class</code> <code>EmbeddingDotBias</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L36" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EmbeddingDotBias</code>(<strong><code>n_factors</code></strong>, <strong><code>n_users</code></strong>, <strong><code>n_items</code></strong>, <strong><code>y_range</code></strong>=<em><code>None</code></em>) :: <a href="/torch_core.html#Module"><code>Module</code></a></p>
</blockquote>
<p>Base dot model for collaborative filtering.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The model is built with <code>n_factors</code> (the length of the internal vectors), <code>n_users</code> and <code>n_items</code>. For a given user and item, it grabs the corresponding weights and bias and returns</p>
<div class="highlight"><pre><span></span><span class="n">torch</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">user_w</span><span class="p">,</span> <span class="n">item_w</span><span class="p">)</span> <span class="o">+</span> <span class="n">user_b</span> <span class="o">+</span> <span class="n">item_b</span>
</pre></div>
<p>Optionally, if <code>y_range</code> is passed, it applies a <a href="/layers.html#SigmoidRange"><code>SigmoidRange</code></a> to that result.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">x</span><span class="p">,</span><span class="n">y</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">one_batch</span><span class="p">()</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">EmbeddingDotBias</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="s1">&#39;userId&#39;</span><span class="p">]),</span> <span class="nb">len</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">]),</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                        <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingDotBias.from_classes" class="doc_header"><code>EmbeddingDotBias.from_classes</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L51" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingDotBias.from_classes</code>(<strong><code>n_factors</code></strong>, <strong><code>classes</code></strong>, <strong><code>user</code></strong>=<em><code>None</code></em>, <strong><code>item</code></strong>=<em><code>None</code></em>, <strong><code>y_range</code></strong>=<em><code>None</code></em>)</p>
</blockquote>
<p>Build a model with <code>n_factors</code> by inferring <code>n_users</code> and  <code>n_items</code> from <code>classes</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>y_range</code> is passed to the main init. <code>user</code> and <code>item</code> are the names of the keys for users and items in <code>classes</code> (default to the first and second key respectively). <code>classes</code> is expected to be a dictionary key to list of categories like the result of <code>dls.classes</code> in a <a href="/collab.html#CollabDataLoaders"><code>CollabDataLoaders</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">dls</span><span class="o">.</span><span class="n">classes</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">



<div class="output_text output_subarea output_execute_result">
<pre>{&#39;userId&#39;: (#101) [&#39;#na#&#39;,15,17,19,23,30,48,56,73,77...],
 &#39;movieId&#39;: (#101) [&#39;#na#&#39;,1,10,32,34,39,47,50,110,150...]}</pre>
</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Let's see how it can be used in practice:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">model</span> <span class="o">=</span> <span class="n">EmbeddingDotBias</span><span class="o">.</span><span class="n">from_classes</span><span class="p">(</span><span class="mi">50</span><span class="p">,</span> <span class="n">dls</span><span class="o">.</span><span class="n">classes</span><span class="p">,</span>  <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                                     <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Two convenience methods are added to easily access the weights and bias when a model is created with <a href="/collab.html#EmbeddingDotBias.from_classes"><code>EmbeddingDotBias.from_classes</code></a>:</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingDotBias.weight" class="doc_header"><code>EmbeddingDotBias.weight</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L76" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingDotBias.weight</code>(<strong><code>arr</code></strong>, <strong><code>is_item</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Weight for item or user (based on <code>is_item</code>) for all in <code>arr</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The elements of <code>arr</code> are expected to be class names (which is why the model needs to be created with <a href="/collab.html#EmbeddingDotBias.from_classes"><code>EmbeddingDotBias.from_classes</code></a>)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mov</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">][</span><span class="mi">42</span><span class="p">]</span> 
<span class="n">w</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">weight</span><span class="p">([</span><span class="n">mov</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">w</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">i_weight</span><span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">42</span><span class="p">])))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="EmbeddingDotBias.bias" class="doc_header"><code>EmbeddingDotBias.bias</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L70" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>EmbeddingDotBias.bias</code>(<strong><code>arr</code></strong>, <strong><code>is_item</code></strong>=<em><code>True</code></em>)</p>
</blockquote>
<p>Bias for item or user (based on <code>is_item</code>) for all in <code>arr</code></p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The elements of <code>arr</code> are expected to be class names (which is why the model needs to be created with <a href="/collab.html#EmbeddingDotBias.from_classes"><code>EmbeddingDotBias.from_classes</code></a>)</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">mov</span> <span class="o">=</span> <span class="n">dls</span><span class="o">.</span><span class="n">classes</span><span class="p">[</span><span class="s1">&#39;movieId&#39;</span><span class="p">][</span><span class="mi">42</span><span class="p">]</span> 
<span class="n">b</span> <span class="o">=</span> <span class="n">model</span><span class="o">.</span><span class="n">bias</span><span class="p">([</span><span class="n">mov</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">b</span><span class="p">,</span> <span class="n">model</span><span class="o">.</span><span class="n">i_bias</span><span class="p">(</span><span class="n">tensor</span><span class="p">([</span><span class="mi">42</span><span class="p">])))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h2 id="EmbeddingNN" class="doc_header"><code>class</code> <code>EmbeddingNN</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L83" class="source_link" style="float:right">[source]</a></h2><blockquote><p><code>EmbeddingNN</code>(<strong><code>emb_szs</code></strong>, <strong><code>layers</code></strong>, <strong><code>ps</code></strong>:<code>(float, list)</code>=<em><code>None</code></em>, <strong><code>embed_p</code></strong>:<code>float</code>=<em><code>0.0</code></em>, <strong><code>y_range</code></strong>=<em><code>None</code></em>, <strong><code>use_bn</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>bn_final</code></strong>:<code>bool</code>=<em><code>False</code></em>, <strong><code>bn_cont</code></strong>:<code>bool</code>=<em><code>True</code></em>, <strong><code>act_cls</code></strong>=<em><code>ReLU(inplace=True)</code></em>, <strong><code>lin_first</code></strong>:<code>bool</code>=<em><code>True</code></em>) :: <a href="/tabular.model.html#TabularModel"><code>TabularModel</code></a></p>
</blockquote>
<p>Subclass <a href="/tabular.model.html#TabularModel"><code>TabularModel</code></a> to create a NN suitable for collaborative filtering.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p><code>emb_szs</code> should be a list of two tuples, one for the users, one for the items, each tuple containing the number of users/items and the corresponding embedding size (the function <a href="/tabular.model.html#get_emb_sz"><code>get_emb_sz</code></a> can give a good default). All the other arguments are passed to <a href="/tabular.model.html#TabularModel"><code>TabularModel</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">emb_szs</span> <span class="o">=</span> <span class="n">get_emb_sz</span><span class="p">(</span><span class="n">dls</span><span class="o">.</span><span class="n">train_ds</span><span class="p">,</span> <span class="p">{})</span>
<span class="n">model</span> <span class="o">=</span> <span class="n">EmbeddingNN</span><span class="p">(</span><span class="n">emb_szs</span><span class="p">,</span> <span class="p">[</span><span class="mi">50</span><span class="p">],</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">)</span>
                   <span class="p">)</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">device</span><span class="p">)</span>
<span class="n">out</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>
<span class="k">assert</span> <span class="p">(</span><span class="mi">0</span> <span class="o">&lt;=</span> <span class="n">out</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span> <span class="ow">and</span> <span class="p">(</span><span class="n">out</span> <span class="o">&lt;=</span> <span class="mi">5</span><span class="p">)</span><span class="o">.</span><span class="n">all</span><span class="p">()</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Create-a-Learner">Create a <a href="/learner.html#Learner"><code>Learner</code></a><a class="anchor-link" href="#Create-a-Learner"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following function lets us quickly create a <a href="/learner.html#Learner"><code>Learner</code></a> for collaborative filtering from the data.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="collab_learner" class="doc_header"><code>collab_learner</code><a href="https://github.com/fastai/fastai/tree/master/fastai/collab.py#L90" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>collab_learner</code>(<strong><code>dls</code></strong>, <strong><code>n_factors</code></strong>=<em><code>50</code></em>, <strong><code>use_nn</code></strong>=<em><code>False</code></em>, <strong><code>emb_szs</code></strong>=<em><code>None</code></em>, <strong><code>layers</code></strong>=<em><code>None</code></em>, <strong><code>config</code></strong>=<em><code>None</code></em>, <strong><code>y_range</code></strong>=<em><code>None</code></em>, <strong><code>loss_func</code></strong>=<em><code>None</code></em>, <strong><code>opt_func</code></strong>=<em><code>Adam</code></em>, <strong><code>lr</code></strong>=<em><code>0.001</code></em>, <strong><code>splitter</code></strong>=<em><code>trainable_params</code></em>, <strong><code>cbs</code></strong>=<em><code>None</code></em>, <strong><code>metrics</code></strong>=<em><code>None</code></em>, <strong><code>path</code></strong>=<em><code>None</code></em>, <strong><code>model_dir</code></strong>=<em><code>'models'</code></em>, <strong><code>wd</code></strong>=<em><code>None</code></em>, <strong><code>wd_bn_bias</code></strong>=<em><code>False</code></em>, <strong><code>train_bn</code></strong>=<em><code>True</code></em>, <strong><code>moms</code></strong>=<em><code>(0.95, 0.85, 0.95)</code></em>)</p>
</blockquote>
<p>Create a Learner for collaborative filtering on <code>dls</code>.</p>

</div>

</div>

</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">

</div>
    {% endraw %}

<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>If <code>use_nn=False</code>, the model used is an <a href="/collab.html#EmbeddingDotBias"><code>EmbeddingDotBias</code></a> with <code>n_factors</code> and <code>y_range</code>. Otherwise, it's a <a href="/collab.html#EmbeddingNN"><code>EmbeddingNN</code></a> for which you can pass <code>emb_szs</code> (will be inferred from the <code>dls</code> with <a href="/tabular.model.html#get_emb_sz"><code>get_emb_sz</code></a> if you don't provide any), <a href="/layers.html"><code>layers</code></a> (defaults to <code>[n_factors]</code>) <code>y_range</code>, and a <code>config</code> that you can create with <a href="/tabular.model.html#tabular_config"><code>tabular_config</code></a> to customize your model.</p>
<p><code>loss_func</code> will default to <a href="/losses.html#MSELossFlat"><code>MSELossFlat</code></a> and all the other arguments are passed to <a href="/learner.html#Learner"><code>Learner</code></a>.</p>

</div>
</div>
</div>
    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span> <span class="o">=</span> <span class="n">collab_learner</span><span class="p">(</span><span class="n">dls</span><span class="p">,</span> <span class="n">y_range</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">5</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}

    {% raw %}
    
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">learn</span><span class="o">.</span><span class="n">fit_one_cycle</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea "><table border="1" class="dataframe">
  <thead>
    <tr style="text-align: left;">
      <th>epoch</th>
      <th>train_loss</th>
      <th>valid_loss</th>
      <th>time</th>
    </tr>
  </thead>
  <tbody>
    <tr>
      <td>0</td>
      <td>2.521979</td>
      <td>2.541627</td>
      <td>00:00</td>
    </tr>
  </tbody>
</table></div>

</div>

</div>
</div>

</div>
    {% endraw %}

</div>
 

