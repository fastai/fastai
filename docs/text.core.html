---

title: Text core

keywords: fastai
sidebar: home_sidebar

summary: "Basic function to preprocess text before assembling it in a `DataLoaders`."
description: "Basic function to preprocess text before assembling it in a `DataLoaders`."
---
<!--

#################################################
### THIS FILE WAS AUTOGENERATED! DO NOT EDIT! ###
#################################################
# file to edit: nbs/30_text.core.ipynb
# command to build the docs after a change: nbdev_build_docs

-->

<div class="container" id="notebook-container">
    {% raw %}
        
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="kn">from</span> <span class="nn">nbdev.showdoc</span> <span class="kn">import</span> <span class="o">*</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Preprocessing-rules">Preprocessing rules<a class="anchor-link" href="#Preprocessing-rules"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The following are rules applied to texts before or after it's tokenized.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="spec_add_spaces" class="doc_header"><code>spec_add_spaces</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L25" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>spec_add_spaces</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Add spaces around / and #</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;#fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; # fastai&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;/fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; / fastai&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">spec_add_spaces</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">fastai&#39;</span><span class="p">),</span> <span class="s1">&#39; </span><span class="se">\\</span><span class="s1"> fastai&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="rm_useless_spaces" class="doc_header"><code>rm_useless_spaces</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L32" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>rm_useless_spaces</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Remove multiple spaces</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">rm_useless_spaces</span><span class="p">(</span><span class="s1">&#39;a  b   c&#39;</span><span class="p">),</span> <span class="s1">&#39;a b c&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_rep" class="doc_header"><code>replace_rep</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L39" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_rep</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace repetitions at the character level: cccc -- TK_REP 4 c</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It starts replacing at 3 repetitions of the same character or more.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_rep</span><span class="p">(</span><span class="s1">&#39;aa&#39;</span><span class="p">),</span> <span class="s1">&#39;aa&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_rep</span><span class="p">(</span><span class="s1">&#39;aaaa&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{TK_REP}</span><span class="s1"> 4 a &#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_wrep" class="doc_header"><code>replace_wrep</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L50" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_wrep</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace word repetitions: word word word word -- TK_WREP 4 word</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>It starts replacing at 3 repetitions of the same word or more.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah&#39;</span><span class="p">),</span> <span class="s1">&#39;ah ah&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 3 ah &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah   ah  ah&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah ah &#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah  &#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ah ah.&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39; </span><span class="si">{TK_WREP}</span><span class="s1"> 4 ah .&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_wrep</span><span class="p">(</span><span class="s1">&#39;ah ah ahi&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;ah ah ahi&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="fix_html" class="doc_header"><code>fix_html</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L58" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>fix_html</code>(<strong><code>x</code></strong>)</p>
</blockquote>
<p>Various messy things we've seen in documents</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;#39;bli#146;&#39;</span><span class="p">),</span> <span class="s2">&quot;&#39;bli&#39;&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;Sarah amp; Duck...&#39;</span><span class="p">),</span> <span class="s1">&#39;Sarah &amp; Duck …&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;a nbsp; #36;&#39;</span><span class="p">),</span> <span class="s1">&#39;a   $&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;</span><span class="se">\\</span><span class="s1">&quot; &lt;unk&gt;&#39;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;&quot; </span><span class="si">{UNK}</span><span class="s1">&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;quot;  @.@  @-@ &#39;</span><span class="p">),</span> <span class="s2">&quot;&#39; .-&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">fix_html</span><span class="p">(</span><span class="s1">&#39;&lt;br /&gt;text</span><span class="se">\\</span><span class="s1">n&#39;</span><span class="p">),</span> <span class="s1">&#39;</span><span class="se">\n</span><span class="s1">text</span><span class="se">\n</span><span class="s1">&#39;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_all_caps" class="doc_header"><code>replace_all_caps</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L69" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_all_caps</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace tokens in ALL CAPS by their lower version and add <code>TK_UP</code> before.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I&#39;M SHOUTING&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{TK_UP}</span><span class="s2"> i&#39;m </span><span class="si">{TK_UP}</span><span class="s2"> shouting&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I&#39;m speaking normally&quot;</span><span class="p">),</span> <span class="s2">&quot;I&#39;m speaking normally&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_all_caps</span><span class="p">(</span><span class="s2">&quot;I am speaking normally&quot;</span><span class="p">),</span> <span class="s2">&quot;i am speaking normally&quot;</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_maj" class="doc_header"><code>replace_maj</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L80" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_maj</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace tokens in ALL CAPS by their lower version and add <code>TK_UP</code> before.</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">replace_maj</span><span class="p">(</span><span class="s2">&quot;Jeremy Howard&quot;</span><span class="p">),</span> <span class="sa">f</span><span class="s1">&#39;</span><span class="si">{TK_MAJ}</span><span class="s1"> jeremy </span><span class="si">{TK_MAJ}</span><span class="s1"> howard&#39;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">replace_maj</span><span class="p">(</span><span class="s2">&quot;I don&#39;t think there is any maj here&quot;</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;i don&#39;t think there is any maj here&quot;</span><span class="p">),)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="lowercase" class="doc_header"><code>lowercase</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L88" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>lowercase</code>(<strong><code>t</code></strong>, <strong><code>add_bos</code></strong>=<em><code>True</code></em>, <strong><code>add_eos</code></strong>=<em><code>False</code></em>)</p>
</blockquote>
<p>Converts <code>t</code> to lowercase</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="replace_space" class="doc_header"><code>replace_space</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L93" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>replace_space</code>(<strong><code>t</code></strong>)</p>
</blockquote>
<p>Replace embedded spaces in a token with unicode line char to allow for split/join</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Tokenizing">Tokenizing<a class="anchor-link" href="#Tokenizing"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>A tokenizer is a class that must implement a <code>pipe</code> method. This <code>pipe</code> method receives a generator of texts and must return a generator with their tokenized versions. Here is the most basic example:</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="BaseTokenizer" class="doc_header"><code>class</code> <code>BaseTokenizer</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L104" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>BaseTokenizer</code>(<strong><code>split_char</code></strong>=<em><code>' '</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>
<p>Basic tokenizer that just splits on spaces</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok</span> <span class="o">=</span> <span class="n">BaseTokenizer</span><span class="p">()</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">([</span><span class="s2">&quot;This is a text&quot;</span><span class="p">]):</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;This&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">])</span>
<span class="n">tok</span> <span class="o">=</span> <span class="n">BaseTokenizer</span><span class="p">(</span><span class="s1">&#39;x&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">([</span><span class="s2">&quot;This is a text&quot;</span><span class="p">]):</span> <span class="n">test_eq</span><span class="p">(</span><span class="n">t</span><span class="p">,</span> <span class="p">[</span><span class="s2">&quot;This is a te&quot;</span><span class="p">,</span> <span class="s2">&quot;t&quot;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="SpacyTokenizer" class="doc_header"><code>class</code> <code>SpacyTokenizer</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L110" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>SpacyTokenizer</code>(<strong><code>lang</code></strong>=<em><code>'en'</code></em>, <strong><code>special_toks</code></strong>=<em><code>None</code></em>, <strong><code>buf_sz</code></strong>=<em><code>5000</code></em>)</p>
</blockquote>
<p>Spacy tokenizer for <code>lang</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tok</span> <span class="o">=</span> <span class="n">SpacyTokenizer</span><span class="p">()</span>
<span class="n">inp</span><span class="p">,</span><span class="n">exp</span> <span class="o">=</span> <span class="s2">&quot;This isn&#39;t the easiest text.&quot;</span><span class="p">,[</span><span class="s2">&quot;This&quot;</span><span class="p">,</span> <span class="s2">&quot;is&quot;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s2">&quot;the&quot;</span><span class="p">,</span> <span class="s2">&quot;easiest&quot;</span><span class="p">,</span> <span class="s2">&quot;text&quot;</span><span class="p">,</span> <span class="s2">&quot;.&quot;</span><span class="p">]</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">L</span><span class="p">(</span><span class="n">tok</span><span class="p">([</span><span class="n">inp</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)),</span> <span class="p">[</span><span class="n">exp</span><span class="p">]</span><span class="o">*</span><span class="mi">5</span><span class="p">)</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="TokenizeBatch" class="doc_header"><code>class</code> <code>TokenizeBatch</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L125" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>TokenizeBatch</code>(<strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>post_rules</code></strong>=<em><code>None</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>A wrapper around <code>tok_func</code> to apply <code>rules</code> and tokenize in parallel</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">f</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">()</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">([</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">]),</span> <span class="p">[[</span><span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;problem&#39;</span><span class="p">]])</span>
<span class="n">f</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">(</span><span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="p">[],</span> <span class="n">split_char</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">f</span><span class="p">([</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">]),</span> <span class="p">[[</span><span class="s1">&#39;This▁isn&#39;</span><span class="p">,</span> <span class="s1">&#39;t▁a▁problem&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The main function that will be called during one of the processes handling tokenization. It will create an instance of a tokenizer with <code>tok_func</code> and <code>tok_kwargs</code> at init, then iterate through the <code>batch</code> of texts, apply them <code>rules</code> and tokenize them.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;this is a text&quot;</span><span class="p">,</span> <span class="s2">&quot;this is another text&quot;</span><span class="p">]</span>
<span class="n">tok</span> <span class="o">=</span> <span class="n">TokenizeBatch</span><span class="p">(</span><span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">texts</span><span class="o">.</span><span class="fm">__getitem__</span><span class="p">)</span>
<span class="n">test_eq</span><span class="p">([</span><span class="n">t</span> <span class="k">for</span> <span class="n">t</span> <span class="ow">in</span> <span class="n">tok</span><span class="p">([</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">])],[[</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="p">[</span><span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;another&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">]])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tokenize1" class="doc_header"><code>tokenize1</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L136" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize1</code>(<strong><code>text</code></strong>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>post_rules</code></strong>=<em><code>None</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize one <a href="/text"><code>text</code></a> with an instance of <code>tok_func</code> and some <code>rules</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">test_eq</span><span class="p">(</span><span class="n">tokenize1</span><span class="p">(</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">),</span>
        <span class="p">[</span><span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s2">&quot;n&#39;t&quot;</span><span class="p">,</span> <span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;problem&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tokenize1</span><span class="p">(</span><span class="s2">&quot;This isn&#39;t a problem&quot;</span><span class="p">,</span> <span class="n">BaseTokenizer</span><span class="p">,</span> <span class="n">rules</span><span class="o">=</span><span class="p">[],</span> <span class="n">split_char</span><span class="o">=</span><span class="s2">&quot;&#39;&quot;</span><span class="p">),</span>
        <span class="p">[</span><span class="s1">&#39;This▁isn&#39;</span><span class="p">,</span> <span class="s1">&#39;t▁a▁problem&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="parallel_tokenize" class="doc_header"><code>parallel_tokenize</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L141" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>parallel_tokenize</code>(<strong><code>items</code></strong>, <strong><code>tok_func</code></strong>, <strong><code>rules</code></strong>, <strong><code>as_gen</code></strong>=<em><code>False</code></em>, <strong><code>n_workers</code></strong>=<em><code>56</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Calls a potential setup on <code>tok_func</code> before launching <a href="/text.core#TokenizeBatch"><code>TokenizeBatch</code></a> in parallel</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tokenize-texts-in-files">Tokenize texts in files<a class="anchor-link" href="#Tokenize-texts-in-files"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>Preprocessing function for texts in filenames. Tokenized texts will be saved in a similar fashion in a directory suffixed with <code>_tok</code> in the parent folder of <code>path</code> (override with <code>output_dir</code>).</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tokenize_folder" class="doc_header"><code>tokenize_folder</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L152" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_folder</code>(<strong><code>path</code></strong>, <strong><code>extensions</code></strong>=<em><code>None</code></em>, <strong><code>folders</code></strong>=<em><code>None</code></em>, <strong><code>output_dir</code></strong>=<em><code>None</code></em>, <strong><code>n_workers</code></strong>=<em><code>56</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>encoding</code></strong>=<em><code>'utf8'</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize text files in <code>path</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="read_tokenized_file" class="doc_header"><code>read_tokenized_file</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L171" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>read_tokenized_file</code>(<strong><code>f</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The result will be in <code>output_dir</code> (defaults to a folder in the same parent directory as <code>path</code>, with <code>_tok</code> added to <code>path.name</code>) with the same structure as in <code>path</code>. Tokenized texts for a given file will be in the file having the same name in <code>output_dir</code>. Additionally, a file with a .len suffix contains the number of tokens and the count of all words is stored in <code>output_dir/counter.pkl</code>.</p>
<p><code>extensions</code> will default to <code>['.txt']</code> and all text files in <code>path</code> are treated unless you specify a list of folders in <code>include</code>. <code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tokenize_files" class="doc_header"><code>tokenize_files</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L174" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_files</code>(<strong><code>files</code></strong>, <strong><code>output_dir</code></strong>, <strong><code>output_names</code></strong>=<em><code>None</code></em>, <strong><code>n_workers</code></strong>=<em><code>56</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>encoding</code></strong>=<em><code>'utf8'</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize text <code>files</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h3 id="Tokenize-texts-in-a-dataframe">Tokenize texts in a dataframe<a class="anchor-link" href="#Tokenize-texts-in-a-dataframe"> </a></h3>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tokenize_df" class="doc_header"><code>tokenize_df</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L201" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_df</code>(<strong><code>df</code></strong>, <strong><code>text_cols</code></strong>, <strong><code>n_workers</code></strong>=<em><code>56</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>mark_fields</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>res_col_name</code></strong>=<em><code>'text'</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize texts in <code>df[text_cols]</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>This function returns a new dataframe with the same non-text columns, a colum named text that contains the tokenized texts and a column named text_lengths that contains their respective length. It also returns a counter of all words see to quickly build a vocabulary afterward.</p>
<p><code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer. If <code>mark_fields</code> isn't specified, it defaults to <code>False</code> when there is a single text column, <code>True</code> when there are several. In that case, the texts in each of those columns are joined with <code>FLD</code> markes followed by the number of the field.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="tokenize_csv" class="doc_header"><code>tokenize_csv</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L219" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>tokenize_csv</code>(<strong><code>fname</code></strong>, <strong><code>text_cols</code></strong>, <strong><code>outname</code></strong>=<em><code>None</code></em>, <strong><code>n_workers</code></strong>=<em><code>4</code></em>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>mark_fields</code></strong>=<em><code>None</code></em>, <strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong><code>header</code></strong>=<em><code>'infer'</code></em>, <strong><code>chunksize</code></strong>=<em><code>50000</code></em>, <strong>**<code>tok_kwargs</code></strong>)</p>
</blockquote>
<p>Tokenize texts in the <code>text_cols</code> of the csv <code>fname</code> in parallel using <code>n_workers</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="load_tokenized_csv" class="doc_header"><code>load_tokenized_csv</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L236" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>load_tokenized_csv</code>(<strong><code>fname</code></strong>)</p>
</blockquote>
<p>Utility function to quickly load a tokenized csv ans the corresponding counter</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<p>The result will be written in a new csv file in <code>outname</code> (defaults to the same as <code>fname</code> with the suffix <code>_tok.csv</code>) and will have the same header as the original file, the same non-text columns, a text and a text_lengths column as described in <a href="/text.core#tokenize_df"><code>tokenize_df</code></a>.</p>
<p><code>tok_func</code> is instantiated in each process with <code>tok_kwargs</code>, and <code>rules</code> (that defaults to <a href="/text.core#defaults.text_proc_rules"><code>defaults.text_proc_rules</code></a>) are applied to each text before going in the tokenizer. If <code>mark_fields</code> isn't specified, it defaults to <code>False</code> when there is a single text column, <code>True</code> when there are several. In that case, the texts in each of those columns are joined with <code>FLD</code> markes followed by the number of the field.</p>
<p>The csv file is opened with <code>header</code> and optionally with blocks of <code>chunksize</code> at a time. If this argument is passed, each chunk is processed independtly and saved in the output file to save memory usage.</p>

</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">def</span> <span class="nf">_prepare_texts</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">):</span>
    <span class="s2">&quot;Prepare texts in a folder struct in tmp_d, a csv file and returns a dataframe&quot;</span>
    <span class="n">path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;tmp&#39;</span>
    <span class="n">path</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span> 
        <span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">d</span><span class="p">)</span><span class="o">.</span><span class="n">mkdir</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">,</span> <span class="s1">&#39;w&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span> <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{d}</span><span class="s2"> </span><span class="si">{i}</span><span class="s2">&quot;</span><span class="p">)</span>
    
    <span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{d}</span><span class="s2"> </span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]]</span>
    <span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">15</span><span class="p">))},</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
    <span class="n">csv_fname</span> <span class="o">=</span> <span class="n">tmp_d</span><span class="o">/</span><span class="s1">&#39;input.csv&#39;</span>
    <span class="n">df</span><span class="o">.</span><span class="n">to_csv</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">path</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">csv_fname</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_d</span><span class="p">:</span>
    <span class="n">path</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">csv_fname</span> <span class="o">=</span> <span class="n">_prepare_texts</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">))</span>
    <span class="c1">#Tokenize as folders</span>
    <span class="n">tokenize_folder</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">outp</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;tmp_tok&#39;</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]:</span> 
        <span class="n">p</span> <span class="o">=</span> <span class="n">outp</span><span class="o">/</span><span class="n">d</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
            <span class="n">test_eq</span><span class="p">((</span><span class="n">p</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">d</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">i</span><span class="p">)</span> <span class="p">]))</span>
    <span class="n">cnt_a</span> <span class="o">=</span> <span class="p">(</span><span class="n">outp</span><span class="o">/</span><span class="n">fn_counter_pkl</span><span class="p">)</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">cnt_a</span><span class="p">[</span><span class="s1">&#39;this&#39;</span><span class="p">],</span> <span class="mi">15</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">cnt_a</span><span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">],</span> <span class="mi">5</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">cnt_a</span><span class="p">[</span><span class="s1">&#39;0&#39;</span><span class="p">],</span> <span class="mi">3</span><span class="p">)</span>
    
    <span class="c1">#Tokenize as files</span>
    <span class="n">files</span> <span class="o">=</span> <span class="n">get_text_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">tokenize_files</span><span class="p">(</span><span class="n">files</span><span class="p">,</span> <span class="n">path</span><span class="o">/</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span><span class="n">f</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">files</span><span class="p">):</span> 
        <span class="n">test_eq</span><span class="p">((</span><span class="n">path</span><span class="o">/</span><span class="s1">&#39;d&#39;</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">(),</span> <span class="s1">&#39; &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span>
                <span class="n">BOS</span><span class="p">,</span> <span class="n">TK_MAJ</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span> <span class="s1">&#39;is&#39;</span><span class="p">,</span> <span class="s1">&#39;an&#39;</span><span class="p">,</span> <span class="s1">&#39;example&#39;</span><span class="p">,</span> <span class="s1">&#39;of&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">f</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">4</span><span class="p">]]))</span>
    
    <span class="c1">#Tokenize as a dataframe</span>
    <span class="n">out</span><span class="p">,</span><span class="n">cnt_b</span> <span class="o">=</span> <span class="n">tokenize_df</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="n">text_cols</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">out</span><span class="o">.</span><span class="n">columns</span><span class="p">),</span> <span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">,</span> <span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;text_length&#39;</span><span class="p">])</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">,</span> <span class="n">df</span><span class="p">[</span><span class="s1">&#39;label&#39;</span><span class="p">]</span><span class="o">.</span><span class="n">values</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">out</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">],</span> <span class="p">[(</span><span class="n">outp</span><span class="o">/</span><span class="n">d</span><span class="o">/</span><span class="sa">f</span><span class="s1">&#39;text</span><span class="si">{i}</span><span class="s1">.txt&#39;</span><span class="p">)</span><span class="o">.</span><span class="n">read</span><span class="p">()</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;a&#39;</span><span class="p">,</span> <span class="s1">&#39;b&#39;</span><span class="p">,</span> <span class="s1">&#39;c&#39;</span><span class="p">]])</span>
    <span class="n">test_eq</span><span class="p">(</span><span class="n">cnt_a</span><span class="p">,</span> <span class="n">cnt_b</span><span class="p">)</span>
    
    <span class="c1">#Tokenize as a csv </span>
    <span class="n">out_fname</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">)</span><span class="o">/</span><span class="s1">&#39;output.csv&#39;</span>
    <span class="n">tokenize_csv</span><span class="p">(</span><span class="n">csv_fname</span><span class="p">,</span> <span class="n">text_cols</span><span class="o">=</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="n">outname</span><span class="o">=</span><span class="n">out_fname</span><span class="p">)</span>
    <span class="n">test_eq</span><span class="p">((</span><span class="n">out</span><span class="p">,</span><span class="n">cnt_b</span><span class="p">),</span> <span class="n">load_tokenized_csv</span><span class="p">(</span><span class="n">out_fname</span><span class="p">))</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h4 id="get_tokenizer" class="doc_header"><code>get_tokenizer</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L245" class="source_link" style="float:right">[source]</a></h4><blockquote><p><code>get_tokenizer</code>(<strong><code>tok_func</code></strong>=<em><code>'SpacyTokenizer'</code></em>, <strong>**<code>kwargs</code></strong>)</p>
</blockquote>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="Tokenizer" class="doc_header"><code>class</code> <code>Tokenizer</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L252" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>Tokenizer</code>(<strong><code>tokenizer</code></strong>, <strong><code>rules</code></strong>=<em><code>None</code></em>, <strong><code>counter</code></strong>=<em><code>None</code></em>, <strong><code>lengths</code></strong>=<em><code>None</code></em>, <strong><code>mode</code></strong>=<em><code>None</code></em>, <strong><code>sep</code></strong>=<em><code>' '</code></em>) :: <a href="https://fastcore.fast.ai/transform#Transform"><code>Transform</code></a></p>
</blockquote>
<p>Delegates (<code>__call__</code>,<code>decode</code>,<code>setup</code>) to (<a href="/tabular.core#encodes"><code>encodes</code></a>,<a href="/tabular.core#decodes"><code>decodes</code></a>,<a href="/tabular.core#setups"><code>setups</code></a>) if <code>split_idx</code> matches</p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">TemporaryDirectory</span><span class="p">()</span> <span class="k">as</span> <span class="n">tmp_d</span><span class="p">:</span>
    <span class="n">path</span><span class="p">,</span><span class="n">df</span><span class="p">,</span><span class="n">csv_fname</span> <span class="o">=</span> <span class="n">_prepare_texts</span><span class="p">(</span><span class="n">Path</span><span class="p">(</span><span class="n">tmp_d</span><span class="p">))</span>
    <span class="n">items</span> <span class="o">=</span> <span class="n">get_text_files</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="n">splits</span> <span class="o">=</span> <span class="n">RandomSplitter</span><span class="p">()(</span><span class="n">items</span><span class="p">)</span>
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">items</span><span class="p">,</span> <span class="p">[</span><span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_folder</span><span class="p">(</span><span class="n">path</span><span class="p">)],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    
    <span class="n">dsets</span> <span class="o">=</span> <span class="n">Datasets</span><span class="p">(</span><span class="n">df</span><span class="p">,</span> <span class="p">[[</span><span class="n">attrgetter</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">),</span> <span class="n">Tokenizer</span><span class="o">.</span><span class="n">from_df</span><span class="p">(</span><span class="s1">&#39;text&#39;</span><span class="p">)]],</span> <span class="n">splits</span><span class="o">=</span><span class="n">splits</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">dsets</span><span class="o">.</span><span class="n">train</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>((#10) [&#39;xxbos&#39;,&#39;xxmaj&#39;,&#39;this&#39;,&#39;is&#39;,&#39;an&#39;,&#39;example&#39;,&#39;of&#39;,&#39;text&#39;,&#39;a&#39;,&#39;3&#39;],)
</pre>
</div>
</div>

<div class="output_area">


<div class="output_html rendered_html output_subarea ">

</div>

</div>

<div class="output_area">

<div class="output_subarea output_stream output_stdout output_text">
<pre>(((#2) [&#39;xxbos&#39;,&#39;xxbos&#39;], (#2) [&#39;xxbos&#39;,&#39;xxmaj&#39;], (#2) [&#39;xxbos&#39;,&#39;this&#39;], (#2) [&#39;xxbos&#39;,&#39;is&#39;], (#2) [&#39;xxbos&#39;,&#39;an&#39;], (#2) [&#39;xxbos&#39;,&#39;example&#39;], (#2) [&#39;xxbos&#39;,&#39;of&#39;], (#2) [&#39;xxbos&#39;,&#39;text&#39;], (#2) [&#39;xxbos&#39;,&#39;a&#39;], (#2) [&#39;xxbos&#39;,&#39;3&#39;]),)
</pre>
</div>
</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">tst</span> <span class="o">=</span> <span class="n">test_set</span><span class="p">(</span><span class="n">dsets</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;This is a test&#39;</span><span class="p">,</span> <span class="s1">&#39;this is another test&#39;</span><span class="p">])</span>
<span class="n">test_eq</span><span class="p">(</span><span class="n">tst</span><span class="p">,</span> <span class="p">[([</span><span class="s1">&#39;xxbos&#39;</span><span class="p">,</span> <span class="s1">&#39;xxmaj&#39;</span><span class="p">,</span> <span class="s1">&#39;this&#39;</span><span class="p">,</span><span class="s1">&#39;is&#39;</span><span class="p">,</span><span class="s1">&#39;a&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">],),</span> 
              <span class="p">([</span><span class="s1">&#39;xxbos&#39;</span><span class="p">,</span><span class="s1">&#39;this&#39;</span><span class="p">,</span><span class="s1">&#39;is&#39;</span><span class="p">,</span><span class="s1">&#39;another&#39;</span><span class="p">,</span><span class="s1">&#39;test&#39;</span><span class="p">],)])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing text_cell rendered"><div class="inner_cell">
<div class="text_cell_render border-box-sizing rendered_html">
<h2 id="Sentencepiece">Sentencepiece<a class="anchor-link" href="#Sentencepiece"> </a></h2>
</div>
</div>
</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">

<div class="output_wrapper">
<div class="output">

<div class="output_area">


<div class="output_markdown rendered_html output_subarea ">
<h3 id="SentencePieceTokenizer" class="doc_header"><code>class</code> <code>SentencePieceTokenizer</code><a href="https://github.com/fastai/fastai2/tree/master/fastai2/text/core.py#L309" class="source_link" style="float:right">[source]</a></h3><blockquote><p><code>SentencePieceTokenizer</code>(<strong><code>lang</code></strong>=<em><code>'en'</code></em>, <strong><code>special_toks</code></strong>=<em><code>None</code></em>, <strong><code>sp_model</code></strong>=<em><code>None</code></em>, <strong><code>vocab_sz</code></strong>=<em><code>None</code></em>, <strong><code>max_vocab_sz</code></strong>=<em><code>30000</code></em>, <strong><code>model_type</code></strong>=<em><code>'unigram'</code></em>, <strong><code>char_coverage</code></strong>=<em><code>None</code></em>, <strong><code>cache_dir</code></strong>=<em><code>'tmp'</code></em>)</p>
</blockquote>
<p>Spacy tokenizer for <code>lang</code></p>

</div>

</div>

</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="n">texts</span> <span class="o">=</span> <span class="p">[</span><span class="sa">f</span><span class="s2">&quot;This is an example of text </span><span class="si">{i}</span><span class="s2">&quot;</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">)]</span>
<span class="n">df</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">DataFrame</span><span class="p">({</span><span class="s1">&#39;text&#39;</span><span class="p">:</span> <span class="n">texts</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">:</span> <span class="nb">list</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">))},</span> <span class="n">columns</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;text&#39;</span><span class="p">,</span> <span class="s1">&#39;label&#39;</span><span class="p">])</span>
</pre></div>

    </div>
</div>
</div>

</div>
<div class="cell border-box-sizing code_cell rendered">
<div class="input">

<div class="inner_cell">
    <div class="input_area">
<div class=" highlight hl-ipython3"><pre><span></span><span class="c1">#Prints too much in stdout. Uncomment when tests are debugged</span>
<span class="c1">#out,cnt = tokenize_df(df, text_cols=&#39;text&#39;, tok_func=SentencePieceTokenizer, vocab_sz=34)</span>
</pre></div>

    </div>
</div>
</div>

</div>
    {% endraw %}
</div>
 

